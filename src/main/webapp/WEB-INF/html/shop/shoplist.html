<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../resources/css/bootstrap.css">
    <link href="https://cdn.bootcss.com/font-awesome/5.10.0-12/css/all.css" rel="stylesheet">
    <script src="../resources/js/commons/jQuery.min.js"></script>
    <script src="../resources/js/bootstrap.js"></script>
    <title>商铺列表</title>
</head>
<body>

<div class="all-wrap">

    <div class="nav-bar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <div class="navbar-brand">商铺后台管理系统</div>
            </div>
            <div class="hidden-xs">
                <ul class="nav navbar-nav">
                    <li><a href="#">Home</a></li>
                </ul>
                <div class="navbar-right navbar-text">欢迎你，<a href="#" id="user-name"></a></div>
            </div>
        </div>
    </div>


    <div class="col-md-12">

        <ol class="breadcrumb">
            <li><a href="#">首页</a></li>
            <li><a href="#">商铺列表</a></li>
        </ol>

        <div class="panel panel-default m10">

            <div class="panel-heading">
                商店<a class="btn btn-primary btn-sm" href="/shopping/shopadmin/shopoperation">+</a>
            </div>

            <table class="table table-striped">
                <thead>
                <tr>
                    <th>#</th>
                    <th>商店名称</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
                </thead>

                <tbody class="shop-wrap" id="shop-wrap">

                </tbody>

            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="shop-edit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">商铺编辑</h4>
            </div>
            <div class="modal-body">
                <form action="">
                    <div class="form-group">
                        <label>商铺名称</label>
                        <div class="item-input">
                            <input class="form-control" type="text" id="shop-name" placeholder="商铺名称">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>商铺分类</label>
                        <select class="form-control" id="shop-category">

                        </select>
                    </div>
                    <div class="form-group">
                        <label>所属区域</label>
                        <select class="form-control" id="area">

                        </select>
                    </div>
                    <div class="form-group">
                        <label>详细地址</label>
                        <input class="form-control" type="text" id="shop-addr" placeholder="详细地址">
                    </div>
                    <div class="form-group">
                        <label>联系电话</label>
                        <input class="form-control" type="text" id="shop-phone" placeholder="联系电话">
                    </div>
                    <div class="form-group">
                        <label>简介</label>
                        <textarea class="form-control" id="shop-desc" placeholder="简介"></textarea>
                    </div>
                    <div class="form-group">
                        <label>缩略图</label>
                        <input class="form-control-file" type="file" id="shop-img" placeholder="缩略图">
                    </div>
                    <div class="form-group form-inline">
                        <div>验证码:</div>
                        <input class="form-control" type="text" id="j_captcha" name="verifyCode" placeholder="验证码">
                        <div class="item-input">
                            <img id="captcha_img" type="text" alt="点击更换" title="点击更换"
                                 onclick="changeVerityCode(this)"
                                 src="../Kaptcha">
                        </div>
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="submit">保存</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../resources/js/commons/common.js" charset="UTF-8"></script>
<script src="../resources/js/shop/shoplist.js"></script>

<script>

    var shopInfoUrl = '/shopping/shopadmin/getshopbyid?shopId=';
    var editShopUrl = '/shopping/shopadmin/updateShop';
    var saveCurrentShop = '/shopping/shopadmin/getshopmanagementinfo';


    $(document).on("click", ".btn-more", function () {
        var shopId = $(this).data("id");
        console.info(shopId);
        $.ajax({
            url: saveCurrentShop,
            type: 'POST',
            data: {
                shopId: shopId
            },
            success: function (data) {
                console.info("传递成功！");
            }
        });
    });

    $(document).on("click", ".shop-edit-btn", function () {

        var shopId = $(this).attr("data-id");

        $.getJSON(shopInfoUrl + shopId, function (data) {
            if (data.success) {
                var shop = data.shop;
                $('#shop-name').val(shop.shopName);
                $('#shop-desc').val(shop.shopDesc);
                $('#shop-phone').val(shop.phone);
                $('#shop-addr').val(shop.shopAddr);

                var shopCategory = '<option selected="selected" data-id='
                    + shop.shopCategory.shopCategoryId + '>'
                    + shop.shopCategory.shopCategoryName + '</option>';

                var tampAreaHtml = '';

                data.areaList.map(function (value, index) {
                    tampAreaHtml += '<option data-id="' + value.areaId + '">' +
                        value.areaName + '</option>';
                });

                $('#shop-category').html(shopCategory);
                $('#shop-category').attr('disabled', 'disabled');
                $('#area').html(tampAreaHtml);
                $("#area option[data-id='" + shop.area.areaId + "']").attr('selected', 'selected');
                $("#submit").attr("data-id", shopId);
            }
        });

    });

    //提交表单数据
    $('#submit').click(function () {

        var shop = {};

        shop.shopId = $(this).attr("data-id");
        shop.shopName = $('#shop-name').val();
        shop.shopDesc = $('#shop-desc').val();
        shop.phone = $('#shop-phone').val();
        shop.shopAddr = $('#shop-addr').val();
        shop.shopCategory = {
            shopCategoryId: $('#shop-category option:checked').attr('data-id')
        };

        shop.area = {
            areaId: $('#area option:checked').attr('data-id')
        };

        var shopImg = $('#shop-img')[0].files[0];

        var formData = new FormData();
        formData.append("shopImg", shopImg);
        formData.append("shopStr", JSON.stringify(shop));
        var verifyCodeActual = $('#j_captcha').val();
        if (!verifyCodeActual) {
            alert("请输入验证码！");
            return;
        }

        formData.append("verifyCodeActual", verifyCodeActual);

        console.info(shop);

        $.ajax({
            url: editShopUrl,
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            cache: false,
            success: function (data) {
                if (data.success) {
                    alert('提交成功');
                    $("#shop-edit").modal("hide");
                    window.location.href = "/shopping/shopadmin/shoplist";
                } else {
                    alert("提交失败" + data.errMsg);
                }
                $('#captcha_img').click();
            }
        })
    });

</script>


</body>
</html>
